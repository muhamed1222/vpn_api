# –ê–Ω–∞–ª–∏–∑: –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª–∏–ª–∏—Å—å

**–î–∞—Ç–∞:** 2025-01-18 04:40 UTC  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—É–ø–∏–ª –ø–æ–¥–ø–∏—Å–∫—É, –Ω–æ –±–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª–∏–ª–∏—Å—å

---

## –§–∞–∫—Ç—ã

### 1. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ID: 782245481)

| Order ID | Plan | Status | Created | Activated |
|----------|------|--------|---------|-----------|
| `ord_1c186eab...` | plan_30 | COMPLETED | 04:22:42 | 04:23:08 |
| `ord_b9cf0b5b...` | plan_30 | COMPLETED | 03:57:19 | 03:57:51 |
| `ord_63d529be...` | plan_30 | COMPLETED | 03:41:48 | 03:42:43 |

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ –∑–∞–∫–∞–∑—ã COMPLETED –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã

---

### 2. –ë–∏–ª–µ—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü–µ `ticket_ledger`

–ó–∞–ø—Ä–æ—Å:
```sql
SELECT * FROM ticket_ledger 
WHERE order_id IN ('ord_1c186eab...', 'ord_b9cf0b5b...', 'ord_63d529be...');
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚ùå **–ü–£–°–¢–û** - –±–∏–ª–µ—Ç—ã –ù–ï –Ω–∞—á–∏—Å–ª–µ–Ω—ã!

---

### 3. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã

```
ticket_ord_a357d644... | 03:12:19 | SELF_PURCHASE
ticket_ord_02f76367... | 02:17:28 | SELF_PURCHASE
ticket_ord_5903a2e6... | 02:08:01 | SELF_PURCHASE
```

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ:** 03:12:19 (–¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞)

---

### 4. –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞

```bash
‚óè vpn-bot.service - VPN Bot Service
     Active: active (running) since Sun 2026-01-18 03:12:01 UTC
```

**–ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω:** 03:12:01  
**–õ–æ–≥–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:** ‚ùå **–û–¢–°–£–¢–°–¢–í–£–Æ–¢**

---

### 5. –õ–æ–≥–∏ API (outlivion-api)

**–ó–∞–ø—Ä–æ—Å—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞:**
- ‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã (`/v1/referral/tickets`, `/v1/auth/me`)
- ‚ùå **–ù–ï–¢ webhook –∑–∞–ø—Ä–æ—Å–æ–≤** –æ—Ç YooKassa
- ‚ùå **–ù–ï–¢ –ª–æ–≥–æ–≤ –æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–∏–ª–µ—Ç–æ–≤**

---

## –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: –ë–æ—Ç –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
1. –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (active (running))
2. –ó–∞–∫–∞–∑—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è (COMPLETED)
3. **–ù–û –ª–æ–≥–∏ –ù–ï –ø–∏—à—É—Ç—Å—è**

**–ö–æ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
```typescript
// /root/vpn_bot/src/services/orderProcessingService.ts
const ticketAwarded = ContestService.awardSelfPurchaseTicket(
    activeContest.id,
    order.userId,
    order.id,
    order.planId,
    order.createdAt
);
if (ticketAwarded) {
    console.log(`[OrderProcessing] ‚úÖ Successfully awarded self-purchase ticket...`);
} else {
    console.log(`[OrderProcessing] ‚ö†Ô∏è Failed to award self-purchase ticket...`);
}
```

**–ù–û –ª–æ–≥–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è** ‚Üí —Ñ—É–Ω–∫—Ü–∏—è –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–ª–∏ –ª–æ–≥–∏ –∏–¥—É—Ç –Ω–µ —Ç—É–¥–∞!

---

### –í—Ç–æ—Ä–∞—è –ø—Ä–∏—á–∏–Ω–∞: –ü–ª–∞—Ç–µ–∂–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ Telegram, –Ω–µ —á–µ—Ä–µ–∑ YooKassa

**–§–∞–∫—Ç—ã:**
- –ó–∞–∫–∞–∑—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (provider: yoomoney –≤ —Ç–∞–±–ª–∏—Ü–µ)
- –ù–æ webhook –Ω–∞ API –ù–ï –ø—Ä–∏—Ö–æ–¥–∏—Ç
- API –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ YooKassa webhook (`/v1/payments/webhook`)
- Telegram Payments –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø—É—Ç—å

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –õ–æ–≥–∏ –±–æ—Ç–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ñ–∞–π–ª

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–∏—Å–∞
cat /etc/systemd/system/vpn-bot.service

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª–µ
ls -la /root/vpn_bot/logs/
cat /root/vpn_bot/logs/*.log 2>/dev/null | tail -100
```

---

### 2. –ë–æ—Ç –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- –£—Å–ª–æ–≤–∏–µ `if (activeContest)` –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- –§—É–Ω–∫—Ü–∏—è `getActiveContest()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null`
- –ö–æ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±—ã–ª –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–¥
cat /root/vpn_bot/src/services/orderProcessingService.ts | grep -B 5 -A 15 "awardSelfPurchaseTicket"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –ª–∏ –∫–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
cat /root/vpn_bot/dist/*.js | grep "awardSelfPurchaseTicket"
```

---

### 3. –ó–∞–∫–∞–∑—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑ –≤—ã–∑–æ–≤–∞ `orderProcessingService`

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- Telegram Payments –æ–±—Ö–æ–¥—è—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
- Webhook –æ—Ç Telegram –∏–¥–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ orders –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
grep -r "UPDATE orders" /root/vpn_bot/src --include="*.ts"
grep -r "status.*COMPLETED" /root/vpn_bot/src --include="*.ts"
```

---

## –†–µ—à–µ–Ω–∏–µ

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–µ: –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∏–ª–µ—Ç—ã –≤—Ä—É—á–Ω—É—é

```bash
ssh root@72.56.93.135

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —Ä—É—á–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –¥–ª—è 3 –∑–∞–∫–∞–∑–æ–≤
node /opt/outlivion-api/scripts/manual-award-tickets.js \
  ord_1c186eab-f535-45e4-893c-a522a272fccc \
  ord_b9cf0b5b-a325-4495-a7c8-1c1fad0a89d1 \
  ord_63d529be-7d0d-4059-bae3-012573f8965b
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ Awarded 1 ticket for order ord_1c186eab...
‚úÖ Awarded 1 ticket for order ord_b9cf0b5b...
‚úÖ Awarded 1 ticket for order ord_63d529be...
Total: 3 tickets awarded
```

---

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ

#### –®–∞–≥ 1: –í–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±–æ—Ç–µ

```typescript
// /root/vpn_bot/src/services/orderProcessingService.ts

export async function processPayment(order: Order): Promise<void> {
    console.log(`[OrderProcessing] üöÄ STARTED processing payment for order ${order.id}`);
    console.log(`[OrderProcessing] Order details:`, {
        id: order.id,
        userId: order.userId,
        planId: order.planId,
        status: order.status,
        createdAt: order.createdAt
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω–∫—É—Ä—Å
    const activeContest = ContestService.getActiveContest();
    console.log(`[OrderProcessing] Active contest:`, activeContest ? {
        id: activeContest.id,
        title: activeContest.title
    } : 'NONE');

    if (activeContest) {
        console.log(`[OrderProcessing] Attempting to award self-purchase ticket...`);
        const ticketAwarded = ContestService.awardSelfPurchaseTicket(
            activeContest.id,
            order.userId,
            order.id,
            order.planId,
            order.createdAt
        );
        console.log(`[OrderProcessing] Ticket award result: ${ticketAwarded ? 'SUCCESS ‚úÖ' : 'FAILED ‚ùå'}`);
    } else {
        console.log(`[OrderProcessing] ‚ö†Ô∏è No active contest, skipping ticket award`);
    }
}
```

#### –®–∞–≥ 2: –ü–µ—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

```bash
cd /root/vpn_bot
npm run build
systemctl restart vpn-bot
journalctl -u vpn-bot -f
```

#### –®–∞–≥ 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫—É

1. –ö—É–ø–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
   ```bash
   journalctl -u vpn-bot -n 50 --no-pager | grep "OrderProcessing"
   ```
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ:
   ```bash
   sqlite3 /root/vpn_bot/data/database.sqlite \
     "SELECT * FROM ticket_ledger ORDER BY created_at DESC LIMIT 5;"
   ```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:

```
[OrderProcessing] üöÄ STARTED processing payment for order ord_...
[OrderProcessing] Order details: { id: '...', userId: 782245481, ... }
[OrderProcessing] Active contest: { id: '550e8400...', title: 'üéâ –†–æ–∑—ã–≥—Ä—ã—à...' }
[OrderProcessing] Attempting to award self-purchase ticket...
[OrderProcessing] Ticket award result: SUCCESS ‚úÖ
```

### 2. –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

```sql
SELECT id, referrer_id, referred_id, order_id, delta, reason, created_at 
FROM ticket_ledger 
WHERE order_id = 'ord_...'
ORDER BY created_at DESC 
LIMIT 1;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
ticket_ord_...   | 782245481 | 782245481 | ord_... | 1 | SELF_PURCHASE | 2026-01-18 ...
```

---

## –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –°–ï–ô–ß–ê–°

–ü–æ–∫–∞ —è –∏—Å–ø—Ä–∞–≤–ª—è—é –∫–æ–¥, **–Ω–∞—á–∏—Å–ª–∏—Ç—å –±–∏–ª–µ—Ç—ã –≤—Ä—É—á–Ω—É—é** –¥–ª—è —ç—Ç–∏—Ö 3 –∑–∞–∫–∞–∑–æ–≤.

**–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:** –•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è:
1. ‚úÖ **–ù–∞—á–∏—Å–ª–∏–ª –±–∏–ª–µ—Ç—ã –≤—Ä—É—á–Ω—É—é –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å** (3 –±–∏–ª–µ—Ç–∞)
2. ‚úÖ **–ò—Å–ø—Ä–∞–≤–∏–ª –∫–æ–¥ –±–æ—Ç–∞** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º
3. ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª** –Ω–æ–≤—É—é –ø–æ–∫—É–ø–∫—É

–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç–µ?
