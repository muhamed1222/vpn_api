# Начисление билетов при использовании промокодов

**Вопрос:** Начисляются ли билеты, если пользователь покупает подписку с промокодом (со скидкой)?

**Ответ:** ✅ **ДА, билеты начисляются в полном объеме, независимо от промокода/скидки!**

---

## Как работает логика начисления

### Билеты зависят ТОЛЬКО от длительности подписки (plan_id)

**Код в `contestUtils.ts` (строка 20-51):**

```typescript
export function getTicketsFromPlanId(planId: string): number {
  // Фиксированные планы
  if (planId === 'plan_30') return 1;   // 1 месяц = 1 билет
  if (planId === 'plan_90') return 3;   // 3 месяца = 3 билета
  if (planId === 'plan_180') return 6;  // 6 месяцев = 6 билетов
  if (planId === 'plan_365') return 12; // 12 месяцев = 12 билетов
  
  // Динамические планы
  if (planId.startsWith('plan_')) {
    const days = parseInt(planId.substring(5), 10);
    return Math.ceil(days / 30); // Округление вверх
  }
  
  return 0; // Невалидный план
}
```

### Что НЕ проверяется при начислении:

❌ **Сумма оплаты** - не проверяется  
❌ **Наличие промокода** - не проверяется  
❌ **Размер скидки** - не проверяется  
❌ **Цена заказа** - не проверяется  

✅ **Проверяется ТОЛЬКО:** `plan_id` (длительность подписки)

---

## Примеры

### Пример 1: Месячная подписка с промокодом -50%

**Без промокода:**
- План: `plan_30` (1 месяц)
- Цена: 399₽
- Билеты: **1 билет** ✅

**С промокодом -50%:**
- План: `plan_30` (1 месяц)
- Цена: 199₽ (со скидкой)
- Билеты: **1 билет** ✅

**Результат:** Билеты одинаковые (1 билет), независимо от цены!

---

### Пример 2: Годовая подписка с промокодом -70%

**Без промокода:**
- План: `plan_365` (12 месяцев)
- Цена: 3990₽
- Билеты: **12 билетов** ✅

**С промокодом -70%:**
- План: `plan_365` (12 месяцев)
- Цена: 1197₽ (со скидкой)
- Билеты: **12 билетов** ✅

**Результат:** Билеты одинаковые (12 билетов), даже при 70% скидке!

---

### Пример 3: Пробный период (plan_7)

**С любым промокодом:**
- План: `plan_7` (7 дней)
- Цена: любая (даже 0₽)
- Билеты: **0 билетов** ❌

**Исключение:** `plan_7` НИКОГДА не дает билеты (это пробный период)

---

## Логика в коде

### Шаг 1: Определение количества билетов (строка 251)

```typescript
// Рассчитываем количество билетов на основе plan_id
const ticketsDelta = getTicketsFromPlanId(planId);
// ↑ НЕ зависит от цены, промокода или скидки!

if (ticketsDelta <= 0) {
  console.log(`Invalid plan_id: ${planId}`);
  return false; // Не начисляем билеты
}
```

### Шаг 2: Проверки перед начислением

```typescript
// 1. Есть ли активный конкурс?
if (!contest) return false;

// 2. Заказ в периоде конкурса?
if (orderDate < contestStart || orderDate > contestEnd) return false;

// 3. Не пробный план?
if (planId === 'plan_7') return false;

// 4. Все ОК → начисляем billets
const ticketsAwarded = awardTicketsTransaction(...);
```

**Нигде нет проверки на:**
- `order.amount` (сумму оплаты)
- `order.discount` (размер скидки)
- `order.promo_code` (код промокода)
- `order.final_price` (финальную цену)

---

## Почему так сделано?

### Преимущества текущей логики:

1. **Простота:** Не нужно отслеживать цены и скидки
2. **Честность:** Все пользователи с одинаковой подпиской получают одинаковые билеты
3. **Мотивация:** Пользователи мотивированы покупать длинные подписки (больше билетов)
4. **Промоакции:** Можно проводить промоакции без влияния на конкурс

### Логика:

> "Билеты выдаются за **длительность подписки**, а не за потраченные деньги"

---

## Таблица начисления билетов

| План | Длительность | Цена (пример) | С промокодом -50% | Билеты |
|------|--------------|---------------|-------------------|--------|
| `plan_7` | 7 дней | 99₽ | 49₽ | **0** ❌ |
| `plan_30` | 1 месяц | 399₽ | 199₽ | **1** ✅ |
| `plan_90` | 3 месяца | 999₽ | 499₽ | **3** ✅ |
| `plan_180` | 6 месяцев | 1990₽ | 995₽ | **6** ✅ |
| `plan_365` | 12 месяцев | 3990₽ | 1995₽ | **12** ✅ |

**Вывод:** Промокод НЕ влияет на количество билетов!

---

## Что если нужно изменить логику?

Если нужно, чтобы промокоды влияли на билеты, нужно:

### Вариант 1: Уменьшать билеты при больших скидках

```typescript
// Пример: если скидка > 50%, билеты уменьшаются вдвое
const discount = order.discount_percentage || 0;
let ticketsDelta = getTicketsFromPlanId(planId);

if (discount > 50) {
  ticketsDelta = Math.ceil(ticketsDelta / 2);
  console.log(`Reduced tickets due to ${discount}% discount`);
}
```

### Вариант 2: Не начислять при определенных промокодах

```typescript
// Пример: промокоды с префиксом "TRIAL_" не дают билеты
const promoCode = order.promo_code || '';

if (promoCode.startsWith('TRIAL_')) {
  console.log('Trial promo code - no tickets awarded');
  return false;
}
```

### Вариант 3: Билеты на основе суммы оплаты

```typescript
// Пример: 1 билет за каждые 400₽
const amount = order.amount || 0;
const ticketsDelta = Math.floor(amount / 400);

console.log(`Awarded ${ticketsDelta} tickets for ${amount}₽`);
```

---

## Итоговый ответ

### Вопрос: Если человек покупает месячную подписку через промокод, он же тоже начисляется?

### Ответ: ✅ **ДА, БИЛЕТЫ НАЧИСЛЯЮТСЯ В ПОЛНОМ ОБЪЕМЕ!**

**Детали:**
- Месячная подписка (`plan_30`) = **1 билет** ✅
- Неважно, с промокодом или без
- Неважно, какая цена (399₽ или 199₽ со скидкой)
- Важна только **длительность подписки** (1 месяц)

**Исключение:**
- `plan_7` (пробный) = **0 билетов** ❌ (даже без промокода)

---

## Как проверить

Если нужно проверить конкретный заказ с промокодом:

```bash
# 1. Проверить заказ в базе
ssh root@72.56.93.135 "sqlite3 /root/vpn_bot/data/database.sqlite 'SELECT id, plan_id, amount, status FROM orders WHERE id=\"ORDER_ID\";'"

# 2. Проверить билеты для этого заказа
ssh root@72.56.93.135 "sqlite3 /root/vpn_bot/data/database.sqlite 'SELECT * FROM ticket_ledger WHERE order_id=\"ORDER_ID\";'"
```

**Ожидаемый результат:**
- Если `plan_id = 'plan_30'` → 1 запись в `ticket_ledger` с `delta = 1`
- Если `plan_id = 'plan_90'` → 1 запись в `ticket_ledger` с `delta = 3`
- И так далее...

Независимо от того, использовался промокод или нет!
