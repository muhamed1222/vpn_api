# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: YOOKASSA WEBHOOK –û–ë–†–ê–ë–û–¢–ö–ê

**–î–∞—Ç–∞:** 18 —è–Ω–≤–∞—Ä—è 2026  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ YooKassa –ø—Ä–æ—Ö–æ–¥—è—Ç, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üî¥ –°–£–¢–¨ –ü–†–û–ë–õ–ï–ú–´

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –¥–≤—É—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- **–ë–∞–∑–∞ –±–æ—Ç–∞:** `/root/vpn_bot/data/database.sqlite` (280 –∑–∞–∫–∞–∑–æ–≤)
- **–ë–∞–∑–∞ API:** `/root/vpn_api/data/db.sqlite` (1 –∑–∞–∫–∞–∑)

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (–∫–Ω–æ–ø–∫–∞ "üá∑üá∫ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –†–§")
2. –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –≤ **—Å–≤–æ–µ–π** –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. YooKassa –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
4. YooKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ `https://api.outlivion.space/v1/payments/webhook`
5. API –ø–æ–ª—É—á–∞–µ—Ç webhook
6. API –∏—â–µ—Ç –∑–∞–∫–∞–∑ –≤ **—Å–≤–æ–µ–π** –±–∞–∑–µ (`ordersRepo.getOrder(orderId)`)
7. **–ù–ï –ù–ê–•–û–î–ò–¢** –∑–∞–∫–∞–∑ (–æ–Ω –≤ –±–∞–∑–µ –±–æ—Ç–∞!)
8. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200 OK` –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏
9. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è, –±–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è ‚ùå

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–µ (–≤—Ä—É—á–Ω—É—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞)

**–£–∂–µ —Å–¥–µ–ª–∞–Ω–æ –¥–ª—è 2 –ø–ª–∞—Ç–µ–∂–µ–π:**

1. **–ü–ª–∞—Ç–µ–∂ 1:** `30fe83df-000f-5000-b000-1c5910b80057`
   - –ó–∞–∫–∞–∑: `ord_c2cf813e-6d56-4367-a9fc-fd49d2efceda`
   - –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞: +30 –¥–Ω–µ–π
   - –ë–∏–ª–µ—Ç–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ: 20 ‚Üí 21

2. **–ü–ª–∞—Ç–µ–∂ 2:** `30fe86d2-000f-5001-9000-1b32ae3b0742`
   - –ó–∞–∫–∞–∑: `ord_e63f0b27-0755-4b08-8228-f60be77e86fb`
   - –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞: +30 –¥–Ω–µ–π  
   - –ë–∏–ª–µ—Ç–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ: 21 ‚Üí 22

---

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ (–∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

**–§–∞–π–ª:** `/root/vpn_api/src/routes/v1/payments.ts`

**–ù–ê–ô–¢–ò (—Å—Ç—Ä–æ–∫–∞ ~35):**
```typescript
const orderRow = ordersRepo.getOrder(orderId);
```

**–ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê:**
```typescript
// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –±–∞–∑–µ API
let orderRow = ordersRepo.getOrder(orderId);

// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –±–∞–∑–µ –±–æ—Ç–∞
if (!orderRow) {
  const { getDatabase } = await import('../../storage/db.js');
  const db = getDatabase();
  const botDbPath = process.env.BOT_DATABASE_PATH || '/root/vpn_bot/data/database.sqlite';
  
  if (fs.existsSync(botDbPath)) {
    try {
      db.prepare('ATTACH DATABASE ? AS bot_db').run(botDbPath);
      const botOrder = db.prepare(`
        SELECT 
          id as order_id,
          'tg_' || user_id as user_ref,
          plan_id,
          status,
          provider_payment_charge_id as yookassa_payment_id,
          CAST(amount AS TEXT) as amount_value,
          currency as amount_currency,
          NULL as key,
          datetime(created_at/1000, 'unixepoch') as created_at,
          datetime(created_at/1000, 'unixepoch') as updated_at
        FROM bot_db.orders
        WHERE id = ?
        LIMIT 1
      `).get(orderId);
      db.prepare('DETACH DATABASE bot_db').run();
      
      if (botOrder) {
        orderRow = botOrder as any;
        fastify.log.info({ orderId }, '[Webhook] Order found in bot database');
      }
    } catch (e: any) {
      fastify.log.error({ err: e?.message }, '[Webhook] Failed to query bot database');
    }
  }
}
```

---

## üìù –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ü–†–ò–ú–ï–ù–ï–ù–ò–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
```bash
ssh root@72.56.93.135
cd /root/vpn_api/src/routes/v1
cp payments.ts payments.ts.backup_$(date +%s)
```

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
```bash
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é:
nano /root/vpn_api/src/routes/v1/payments.ts

# –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É ~35: const orderRow = ordersRepo.getOrder(orderId);
# –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫–æ–¥ –≤—ã—à–µ
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å API
```bash
systemctl restart outlivion-api
systemctl status outlivion-api
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```bash
journalctl -u outlivion-api -f
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. –°–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (1‚ÇΩ)
2. –î–æ–∂–¥–∞—Ç—å—Å—è webhook –æ—Ç YooKassa (~5-10 —Å–µ–∫)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ API:
   ```bash
   journalctl -u outlivion-api -n 50 | grep -A 10 'Webhook'
   ```
4. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è: `[Webhook] Order found in bot database`
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±–æ—Ç–µ: –ø–æ–¥–ø–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–¥–ª–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∏–ª–µ—Ç—ã: –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏—Å–ª–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°

### –î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
- ‚ùå Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ –∑–∞–∫–∞–∑—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –∫–ª—é—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
- ‚úÖ Webhook –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–∫–∞–∑—ã –≤ –±–∞–∑–µ –±–æ—Ç–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –∫–ª—é—á–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

---

## ‚ö†Ô∏è –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï –†–ï–®–ï–ù–ò–Ø

### –í–∞—Ä–∏–∞–Ω—Ç 1: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≤ –±–æ—Ç–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤ API
- –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –±–æ—Ç–∞

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ï–¥–∏–Ω–∞—è –±–∞–∑–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±–æ—Ç–∞ –∏ API
- –¢—Ä–µ–±—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏

### –í–∞—Ä–∏–∞–Ω—Ç 3: API –≤—ã–∑—ã–≤–∞–µ—Ç –±–æ—Ç–∞ (—Ç–µ–∫—É—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ)
- API –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –±–∞–∑–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ ATTACH DATABASE
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
- ‚úÖ **–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø**

---

## üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ë–†–ê–ë–û–¢–ê–ù–ù–´–• –í–†–£–ß–ù–£–Æ –ü–õ–ê–¢–ï–ñ–ï–ô

| ‚Ññ | –î–∞—Ç–∞ | –ü–ª–∞—Ç–µ–∂ YooKassa | –ó–∞–∫–∞–∑ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | –°—Ç–∞—Ç—É—Å |
|---|------|-----------------|-------|--------------|--------|
| 1 | 18.01 05:31 | 30fe83df | ord_c2cf813e | 782245481 | ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω |
| 2 | 18.01 05:44 | 30fe86d2 | ord_e63f0b27 | 782245481 | ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω |

---

## üéØ –ò–¢–û–ì–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–≤—É—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö  
**–†–µ—à–µ–Ω–∏–µ:** API –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å –±–∞–∑—É –±–æ—Ç–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ webhook  
**–°—Ç–∞—Ç—É—Å:** –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (–≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Å–µ YooKassa –ø–ª–∞—Ç–µ–∂–∏)

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 18.01.2026, 08:48 UTC
