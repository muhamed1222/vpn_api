# –ê–Ω–∞–ª–∏–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ –≤ –±–æ—Ç–µ

## –†–µ–∑—é–º–µ
–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ª–∏ `ContestService.awardSelfPurchaseTicket` –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –≤ –±–æ—Ç–µ.

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ –≤—ã–∑–æ–≤–∞ `awardSelfPurchaseTicket`:

### 1. `src/services/orderProcessingService.ts`

#### –ú–µ—Å—Ç–æ 1: –î–ª—è —É–∂–µ COMPLETED –∑–∞–∫–∞–∑–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 108-145)
```typescript
// –ï—Å–ª–∏ –∑–∞–∫–∞–∑ —É–∂–µ COMPLETED, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏—é –≤ Marzban, –Ω–æ –Ω–∞—á–∏—Å–ª—è–µ–º –±–∏–ª–µ—Ç—ã
const isAlreadyCompleted = orderInDb.status === OrderStatus.COMPLETED;
if (isAlreadyCompleted) {
    // ... –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ ContestService.awardSelfPurchaseTicket
}
```
**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤:** `activateOrder()` –∫–æ–≥–¥–∞ –∑–∞–∫–∞–∑ —É–∂–µ –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å COMPLETED

#### –ú–µ—Å—Ç–æ 2: –î–ª—è –Ω–æ–≤—ã—Ö COMPLETED –∑–∞–∫–∞–∑–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 215-300)
```typescript
// 5. –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω–∫—É—Ä—Å–æ–≤: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤
console.log(`[OrderProcessing] üîµ Checking contest tickets for newly COMPLETED order ${order.id}`);
// ... –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ ContestService.awardSelfPurchaseTicket
```
**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤:** `activateOrder()` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤ Marzban, –∫–æ–≥–¥–∞ —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ COMPLETED

## –ú–µ—Å—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤:

### 1. `src/bot/index.ts`
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç `OrderProcessingService.processPayment()` (—Å—Ç—Ä–æ–∫–∞ ~processPayment)
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç `OrderProcessingService.activateOrder()` (–Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç)
- **–í—Å–µ –∑–∞–∫–∞–∑—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç**

### 2. `src/routes/api.ts`
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç `OrderProcessingService.activateOrder()` (–Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç)
- **–í—Å–µ –∑–∞–∫–∞–∑—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ activateOrder ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç**

### 3. `src/routes/webhooks.ts`
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç `OrderProcessingService.processPayment()` (–¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤)
- `processPayment` –≤—ã–∑—ã–≤–∞–µ—Ç `activateOrder` ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 4. `src/services/orderProcessingService.ts`
- `processPayment()` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `activateOrder()` ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤
- `activateOrder()` ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö (—Å–º. –≤—ã—à–µ)

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

### ‚ùå –ù–ï–¢ –ø—Ä—è–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ COMPLETED
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞, —á—Ç–æ –Ω–µ—Ç –º–µ—Å—Ç, –≥–¥–µ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `DB.updateOrder()` –∏–ª–∏ `DB.updateOrderStatus()` –±–µ–∑ –≤—ã–∑–æ–≤–∞ `activateOrder()`.

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ó–∞–∫–∞–∑—ã, —É–∂–µ COMPLETED –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ
–ï—Å–ª–∏ –∑–∞–∫–∞–∑ —É–∂–µ –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å COMPLETED –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±—ã–ª —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞–ø—Ä—è–º—É—é –≤ –±–∞–∑–µ), –Ω–æ `activateOrder()` –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è:
- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ `activateOrder()` –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
- –ï—Å–ª–∏ `activateOrder()` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è —É–∂–µ COMPLETED –∑–∞–∫–∞–∑–∞ ‚Üí –±–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—Ç—Å—è

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. ‚úÖ **–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è** - –≤—Å–µ –º–µ—Å—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –≤—ã–∑—ã–≤–∞—é—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
2. ‚ö†Ô∏è **–î–ª—è —É–∂–µ COMPLETED –∑–∞–∫–∞–∑–æ–≤** - –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `activateOrder()`, —á—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚úÖ **–î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞** - –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
   - –î–ª—è —É–∂–µ COMPLETED (–ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—ã–∑–æ–≤–µ)
   - –î–ª—è –Ω–æ–≤—ã—Ö COMPLETED (–ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏)

## –í—ã–≤–æ–¥:

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ –±–æ—Ç–∞, –µ—Å–ª–∏:
- –ó–∞–∫–∞–∑—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `processPayment()` –∏–ª–∏ `activateOrder()`
- –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—á—Ç–æ –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç)

**–ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–∫–∞–∑–æ–º `ord_02f76367...`** –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å —Ç–µ–º, —á—Ç–æ:
- –ó–∞–∫–∞–∑ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∫–æ–¥–∞ —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º –±–∏–ª–µ—Ç–æ–≤
- –ò–ª–∏ `activateOrder()` –Ω–µ –±—ã–ª –≤—ã–∑–≤–∞–Ω –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ
