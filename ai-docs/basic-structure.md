# Базовая структура проекта

## Обзор

Проект представляет собой REST API сервер для управления VPN-сервисом, построенный на Fastify и TypeScript. API обеспечивает авторизацию пользователей, создание заказов, обработку платежей через YooKassa и интеграцию с Marzban для управления VPN-подписками.

## Структура директорий

### Корневая директория

- `package.json` - конфигурация зависимостей и скриптов проекта
- `tsconfig.json` - настройки компиляции TypeScript
- `src/` - исходный код приложения
- `dist/` - скомпилированный JavaScript код (генерируется при сборке)
- `data/` - директория для хранения базы данных SQLite
- `deploy/` - конфигурационные файлы для развертывания
- `node_modules/` - установленные зависимости

### Директория `src/`

#### `server.ts`
Точка входа приложения. Инициализирует Fastify сервер, настраивает плагины (CORS, cookies), инициализирует базу данных, создает экземпляры сервисов (YooKassa, Marzban) и регистрирует маршруты. Обрабатывает graceful shutdown.

#### `auth/`
Модули аутентификации и авторизации:
- `jwt.ts` - работа с JWT токенами (создание, верификация)
- `telegram.ts` - верификация Telegram initData для авторизации через Mini App
- `verifyAuth.ts` - middleware для проверки авторизации, поддерживает три способа: Admin API Key, Cookie-based JWT, Telegram initData

#### `config/`
Конфигурационные файлы:
- `plans.ts` - определение тарифных планов и их цен (plan_7, plan_30, plan_90, plan_180, plan_365)
- `yookassa.ts` - IP-адреса YooKassa для валидации webhook-запросов

#### `integrations/`
Интеграции с внешними сервисами:

**`yookassa/`**
- `client.ts` - клиент для работы с YooKassa API (создание платежей)

**`marzban/`**
- `client.ts` - HTTP клиент для взаимодействия с Marzban API
- `service.ts` - сервисный слой для управления пользователями Marzban (активация, продление, регенерация ключей, получение конфигурации)

#### `routes/`
Маршруты API, организованные по версиям:

- `index.ts` - регистрация всех маршрутов приложения
- `root.ts` - корневой маршрут `/` (без rate-limit)
- `health.ts` - health check endpoint `/health` (без rate-limit)

**`v1/`** - API версии 1 (с rate-limit):
- `index.ts` - регистрация всех v1 маршрутов
- `auth.ts` - авторизация через Telegram
- `orders.ts` - создание и получение заказов
- `payments.ts` - обработка webhook от YooKassa
- `user.ts` - получение информации о пользователе и его ключах
- `tariffs.ts` - получение списка доступных тарифов

#### `storage/`
Репозитории для работы с базой данных SQLite:

- `db.ts` - инициализация базы данных, выполнение миграций, создание таблиц (orders, payment_events, vpn_keys)
- `ordersRepo.ts` - операции с заказами (создание, получение, обновление статуса, связывание с платежами)
- `keysRepo.ts` - управление VPN ключами пользователей
- `referralsRepo.ts` - работа с реферальной системой

#### `store/`
Абстракция хранилищ заказов:

- `order-store.ts` - интерфейс хранилища заказов
- `sqlite-order-store.ts` - реализация хранилища на основе SQLite
- `memory-order-store.ts` - реализация хранилища в памяти (для тестирования)

#### `types/`
TypeScript типы и интерфейсы:

- `order.ts` - типы для заказов (Order, CreateOrderRequest, CreateOrderResponse, GetOrderResponse, WebhookEvent)

### Директория `deploy/`

Конфигурационные файлы для развертывания:

- `nginx/api.outlivion.space.conf` - конфигурация Nginx для проксирования запросов к API
- `systemd/outlivion-api.service` - systemd unit файл для запуска сервиса как системного демона

### Директория `data/`

Содержит файл базы данных SQLite (`db.sqlite`), который создается автоматически при первом запуске приложения.

## Архитектура

Проект следует слоистой архитектуре:

1. **Слой маршрутов** (`routes/`) - обработка HTTP запросов, валидация входных данных
2. **Слой сервисов** (`integrations/`) - бизнес-логика и взаимодействие с внешними API
3. **Слой хранилищ** (`store/`, `storage/`) - абстракция доступа к данным
4. **Слой базы данных** (`storage/db.ts`) - прямая работа с SQLite

## Основные компоненты

### База данных

Используется SQLite с тремя основными таблицами:
- `orders` - заказы пользователей
- `payment_events` - события платежей от YooKassa
- `vpn_keys` - VPN ключи пользователей

### Аутентификация

Поддерживается три способа авторизации:
1. Admin API Key (для сервисных запросов от бота)
2. Cookie-based JWT (для браузерных запросов)
3. Telegram initData (для Mini App)

### Интеграции

- **YooKassa** - обработка платежей, создание платежных ссылок, обработка webhook
- **Marzban** - управление VPN пользователями, создание и продление подписок, генерация конфигурационных файлов

## Сборка и запуск

- `npm run dev` - запуск в режиме разработки с hot-reload
- `npm run build` - компиляция TypeScript в JavaScript
- `npm start` - запуск скомпилированного приложения

Исходный код находится в `src/`, скомпилированный код генерируется в `dist/`.
