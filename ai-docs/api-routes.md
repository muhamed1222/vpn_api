# API маршруты

## Базовый URL

Все API запросы выполняются к базовому URL: `https://api.outlivion.space` (или значение из `PUBLIC_BASE_URL`).

## Аутентификация

API поддерживает три способа аутентификации:
1. **JWT в cookie** — устанавливается после авторизации через `/v1/auth/telegram` или `/v1/auth/token`, автоматически отправляется браузером
2. **Telegram initData** — передается в заголовке `Authorization: Bearer {initData}` для Mini App
3. **Admin API Key** — передается в заголовке `x-admin-api-key` для сервисных запросов (используется ботом)

## Rate Limiting

Все маршруты `/v1/*` имеют ограничение: **100 запросов в минуту** на IP-адрес. Общие маршруты (root, health) не ограничены.

## Общие маршруты

### GET /

Корневой маршрут для проверки доступности сервиса.

**Аутентификация:** Не требуется  
**Rate Limit:** Не применяется

**Ответ:**
```json
{
  "ok": true,
  "service": "outlivion-api"
}
```

### GET /health

Health check endpoint для мониторинга состояния сервиса.

**Аутентификация:** Не требуется  
**Rate Limit:** Не применяется

**Ответ:**
```json
{
  "ok": true,
  "ts": "2024-01-01T00:00:00.000Z"
}
```

## API v1 - Аутентификация

### POST /v1/auth/telegram

Авторизация через Telegram Mini App. Проверяет валидность `initData` и создает JWT сессию.

**Аутентификация:** Не требуется  
**Rate Limit:** Применяется

**Тело запроса:**
```json
{
  "initData": "query_id=...&user=...&auth_date=..."
}
```

**Ответ (успех, 200):**
```json
{
  "ok": true,
  "user": {
    "tgId": 12345678,
    "username": "username",
    "firstName": "Name"
  }
}
```

Устанавливает HTTP-only cookie с JWT токеном (срок действия 7 дней).

**Ошибки:**
- `401 Unauthorized` — невалидный или истекший initData

### POST /v1/auth/token

Авторизация по JWT токену, полученному из Telegram-бота. Устанавливает cookie сессию.

**Аутентификация:** Не требуется  
**Rate Limit:** Применяется

**Тело запроса:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Ответ:** Аналогичен `/v1/auth/telegram` — устанавливает cookie с переданным токеном.

**Ошибки:**
- `401 Unauthorized` — невалидный или истекший токен

### GET /v1/auth/me

Получение информации о текущем пользователе и статусе подписки.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ (200):**
```json
{
  "id": 12345678,
  "firstName": "Name",
  "subscription": {
    "is_active": true,
    "expires_at": 1704067200000,
    "vless_key": "vless://..."
  }
}
```

`vless_key` присутствует только при активной подписке.

**Ошибки:**
- `401 Unauthorized` — не авторизован

## API v1 - Заказы

### POST /v1/orders/create

Создание нового заказа на подписку. Создает заказ в БД и платеж в YooKassa.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Тело запроса:**
```json
{
  "planId": "plan_30",
  "tgId": 12345678
}
```

`tgId` требуется только для административных запросов (когда `request.user.isAdmin === true`). Для обычных пользователей берется из JWT токена.

**Ответ (201):**
```json
{
  "orderId": "uuid-v4",
  "status": "pending",
  "paymentUrl": "https://yookassa.ru/..."
}
```

**Ошибки:**
- `400 Bad Request` — невалидные данные, невалидный planId, или попытка купить пробный тариф повторно
- `401 Unauthorized` — не авторизован или отсутствует tgId в токене
- `500 Internal Server Error` — ошибка создания платежа в YooKassa (заказ создан, но платежная ссылка не сгенерирована)

**Бизнес-правила:**
- Пробный тариф (`plan_7`) доступен только один раз на пользователя (проверяется в БД API и бота)
- Заказ создается со статусом `pending` до оплаты
- При создании платежа формируется чек для ФНС (receipt с валидным форматом)

### GET /v1/orders/:orderId

Получение информации о конкретном заказе.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Параметры пути:**
- `orderId` (string) — UUID заказа

**Ответ (200):**
```json
{
  "orderId": "uuid",
  "status": "paid",
  "key": "vless://..."
}
```

Ключ возвращается только для оплаченных заказов (`status === "paid"`).

**Ошибки:**
- `403 Forbidden` — заказ принадлежит другому пользователю
- `404 Not Found` — заказ не найден

### GET /v1/orders/history

История всех заказов текущего пользователя.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ (200):**
```json
[
  {
    "id": "uuid",
    "orderId": "uuid",
    "amount": 99.0,
    "currency": "RUB",
    "date": 1704067200000,
    "status": "success",
    "planName": "plan_30",
    "planId": "plan_30"
  }
]
```

Возвращает до 50 последних заказов, отсортированных по дате создания (новые первые). Статусы: `success` (paid), `pending`, `cancelled` (canceled).

## API v1 - Платежи

### POST /v1/payments/webhook

Webhook endpoint для получения уведомлений от YooKassa о статусе платежей.

**Аутентификация:** Не требуется (опциональная проверка IP адреса отправителя)  
**Rate Limit:** Не применяется

**Тело запроса:**
```json
{
  "type": "notification",
  "event": "payment.succeeded",
  "object": {
    "id": "payment_id",
    "status": "succeeded",
    "paid": true,
    "metadata": {
      "orderId": "uuid"
    }
  }
}
```

**Ответ:** Всегда `200 OK` с телом `{ "ok": true }` (даже при ошибках, чтобы YooKassa не повторял запросы).

**Логика обработки:**
- Обрабатывается только событие `payment.succeeded` со статусом `succeeded`
- Проверяется наличие `orderId` в metadata
- Если заказ уже оплачен и имеет ключ — игнорируется (идемпотентность)
- При успешной оплате автоматически активируется VPN подписка через MarzbanService.activateUser
- Пользователю отправляется уведомление в Telegram с VPN ключом
- Заказ обновляется статусом `paid` и сохраняется VPN ключ
- При ошибке активации админу отправляется уведомление

**Проверка IP:** Опционально (если `YOOKASSA_WEBHOOK_IP_CHECK === "true"`), проверяет, что запрос пришел с IP адресов YooKassa.

### GET /v1/payments/history

История платежей пользователя (только оплаченные и ожидающие оплаты).

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ (200):**
```json
[
  {
    "id": "yookassa_payment_id",
    "orderId": "uuid",
    "amount": 99.0,
    "currency": "RUB",
    "date": 1704067200000,
    "status": "success",
    "planId": "plan_30",
    "planName": "1 месяц"
  }
]
```

Возвращает только заказы со статусом `paid` или `pending`, отсортированные по дате (новые первые). Статусы: `success` (paid), `pending`, `fail` (canceled).

## API v1 - Пользователь

### GET /v1/user/config

Получение VPN конфигурационного ключа (subscription URL).

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ (200):**
```json
{
  "ok": true,
  "config": "https://vpn.outlivion.space/sub/..."
}
```

**Ошибки:**
- `404 Not Found` — у пользователя нет активной подписки

Ключ кэшируется в базе данных (таблица `vpn_keys`) для быстрого доступа. При отсутствии в кэше запрашивается из Marzban и сохраняется.

### GET /v1/user/status

Получение текущего статуса подписки пользователя.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ (200):**
```json
{
  "ok": true,
  "status": "active",
  "expiresAt": 1704067200000,
  "usedTraffic": 1073741824,
  "dataLimit": 0
}
```

Статусы: `active` (подписка активна и не истекла), `disabled` (подписка отсутствует, истекла или неактивна). Временные метки в миллисекундах.

### POST /v1/user/regenerate

Регенерация VPN ключа (сброс токена в Marzban и получение нового ключа).

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ (200):**
```json
{
  "ok": true,
  "config": "https://vpn.outlivion.space/sub/..."
}
```

**Ошибки:**
- `404 Not Found` — пользователь не найден в Marzban

Старый ключ автоматически деактивируется в БД (помечается `is_active = 0`, устанавливается `revoked_at`). Новый ключ также обновляется в последнем оплаченном заказе для совместимости.

### POST /v1/user/renew

Продление подписки пользователя на указанное количество дней (для администраторов и акций).

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Тело запроса:**
```json
{
  "tgId": 12345678,
  "days": 30
}
```

**Ответ (200):**
```json
{
  "ok": true
}
```

Используется для продления подписок из административной панели бота или при применении промокодов/акций.

### GET /v1/user/billing

Статистика использования трафика пользователем.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ (200):**
```json
{
  "usedBytes": 1073741824,
  "limitBytes": null,
  "averagePerDayBytes": 53687091,
  "planId": null,
  "planName": null,
  "period": {
    "start": null,
    "end": 1704067200000
  }
}
```

`averagePerDayBytes` рассчитывается как среднее использование трафика в день с момента начала подписки. Временные метки в миллисекундах.

### GET /v1/user/referrals

Статистика реферальной программы пользователя.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ (200):**
```json
{
  "totalCount": 10,
  "trialCount": 5,
  "premiumCount": 3,
  "referralCode": "REF12345678"
}
```

Данные получаются из базы данных бота (требует `BOT_DATABASE_PATH`). Если база недоступна, возвращает нулевые значения.

## API v1 - Тарифы

### GET /v1/tariffs

Получение списка доступных тарифных планов.

**Аутентификация:** Опциональна  
**Rate Limit:** Применяется

**Ответ (200):**
```json
[
  {
    "id": "plan_30",
    "name": "1 месяц",
    "days": 30,
    "price_rub": 99.0,
    "price_stars": 75
  },
  {
    "id": "plan_7",
    "name": "7 дней",
    "days": 7,
    "price_rub": 10.0,
    "price_stars": 2
  }
]
```

**Особенности:**
- Для неавторизованных пользователей показываются все тарифы, включая пробный (`plan_7`)
- Для авторизованных пользователей пробный тариф (`plan_7`) скрывается, если у них уже были оплаченные заказы
- Проверка выполняется в базе API (`orders` таблица) и, если доступна, в базе бота (`bot_db.orders`)
- Возвращает все тарифы из `PLAN_PRICES` с форматированными названиями

## Коды ошибок

- `400 Bad Request` — невалидные входные данные, нарушение бизнес-правил
- `401 Unauthorized` — требуется аутентификация или невалидный токен
- `403 Forbidden` — доступ запрещен (заказ принадлежит другому пользователю)
- `404 Not Found` — ресурс не найден (заказ, пользователь, подписка)
- `500 Internal Server Error` — внутренняя ошибка сервера

## Формат ошибок

Все ошибки возвращаются в формате:
```json
{
  "error": "ErrorCode",
  "message": "Human readable message",
  "details": {}
}
```

## Тарифные планы

Доступные `planId`:
- `plan_7` — 7 дней (пробный, 10₽ / 2⭐️) — доступен только один раз на пользователя
- `plan_30` — 30 дней (99₽ / 75⭐️)
- `plan_90` — 90 дней (260₽ / 190⭐️)
- `plan_180` — 180 дней (499₽ / 370⭐️)
- `plan_365` — 365 дней (899₽ / 650⭐️)

## Идемпотентность

Критические операции (webhook платежей, сохранение ключей, обновление статусов) реализованы как идемпотентные — повторные вызовы с теми же параметрами не изменяют результат и не вызывают побочных эффектов.
