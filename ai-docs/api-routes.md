# API маршруты

## Базовый URL

Все API запросы выполняются к базовому URL: `https://api.outlivion.space`

## Аутентификация

API поддерживает три способа аутентификации:
1. **JWT в cookie** - устанавливается после авторизации через `/v1/auth/telegram` или `/v1/auth/token`
2. **Telegram initData** - передается в заголовке `Authorization` для Mini App
3. **Admin API Key** - передается в заголовке `x-admin-api-key` для сервисных запросов

## Rate Limiting

Все маршруты `/v1/*` имеют ограничение: **100 запросов в минуту** на IP-адрес.

## Общие маршруты

### GET /

Корневой маршрут для проверки доступности сервиса.

**Аутентификация:** Не требуется  
**Rate Limit:** Не применяется

**Ответ:**
```json
{
  "ok": true,
  "service": "outlivion-api"
}
```

### GET /health

Health check endpoint для мониторинга.

**Аутентификация:** Не требуется  
**Rate Limit:** Не применяется

**Ответ:**
```json
{
  "ok": true,
  "ts": "2024-01-01T00:00:00.000Z"
}
```

## API v1 - Аутентификация

### POST /v1/auth/telegram

Авторизация через Telegram Mini App.

**Аутентификация:** Не требуется  
**Rate Limit:** Применяется

**Тело запроса:**
```json
{
  "initData": "query_id=...&user=..."
}
```

**Ответ (успех):**
```json
{
  "ok": true,
  "user": {
    "tgId": 12345678,
    "username": "username",
    "firstName": "Name"
  }
}
```

Устанавливает JWT cookie для последующих запросов.

**Ошибки:**
- `401 Unauthorized` - невалидный initData

### POST /v1/auth/token

Авторизация по токену из Telegram-бота.

**Аутентификация:** Не требуется  
**Rate Limit:** Применяется

**Тело запроса:**
```json
{
  "token": "jwt_token_string"
}
```

**Ответ:** Аналогичен `/v1/auth/telegram`

### GET /v1/auth/me

Получение информации о текущем пользователе и подписке.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ:**
```json
{
  "id": 12345678,
  "firstName": "Name",
  "subscription": {
    "is_active": true,
    "expires_at": 1704067200000,
    "vless_key": "vless://..."
  }
}
```

## API v1 - Заказы

### POST /v1/orders/create

Создание нового заказа на подписку.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Тело запроса:**
```json
{
  "planId": "plan_30",
  "tgId": 12345678
}
```

`tgId` требуется только для административных запросов. Для обычных пользователей берется из токена.

**Ответ (успех):**
```json
{
  "orderId": "uuid",
  "status": "pending",
  "paymentUrl": "https://yookassa.ru/..."
}
```

**Ошибки:**
- `400 Bad Request` - невалидные данные или попытка купить пробный тариф повторно
- `401 Unauthorized` - не авторизован
- `500 Internal Server Error` - ошибка создания платежа

**Бизнес-правила:**
- Пробный тариф (`plan_7`) доступен только один раз на пользователя
- Заказ создается со статусом `pending` до оплаты

### GET /v1/orders/:orderId

Получение информации о заказе.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Параметры пути:**
- `orderId` - UUID заказа

**Ответ:**
```json
{
  "orderId": "uuid",
  "status": "paid",
  "key": "vless://..."
}
```

Ключ возвращается только для оплаченных заказов.

**Ошибки:**
- `403 Forbidden` - заказ принадлежит другому пользователю
- `404 Not Found` - заказ не найден

### GET /v1/orders/history

История заказов пользователя.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ:**
```json
[
  {
    "id": "uuid",
    "orderId": "uuid",
    "amount": 99.0,
    "currency": "RUB",
    "date": 1704067200000,
    "status": "success",
    "planName": "plan_30",
    "planId": "plan_30"
  }
]
```

Статусы: `success` (paid), `pending`, `cancelled` (canceled)

## API v1 - Платежи

### POST /v1/payments/webhook

Webhook от YooKassa для уведомлений о платежах.

**Аутентификация:** Не требуется (проверка IP опциональна)  
**Rate Limit:** Не применяется

**Тело запроса:**
```json
{
  "type": "notification",
  "event": "payment.succeeded",
  "object": {
    "id": "payment_id",
    "status": "succeeded",
    "paid": true,
    "metadata": {
      "orderId": "uuid"
    }
  }
}
```

**Ответ:** Всегда `200 OK` с `{ "ok": true }`

**Логика:**
- При успешной оплате автоматически активируется VPN подписка
- Пользователю отправляется уведомление в Telegram
- Заказ обновляется статусом `paid` и сохраняется VPN ключ

### GET /v1/payments/history

История платежей пользователя (только оплаченные и ожидающие).

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ:**
```json
[
  {
    "id": "payment_id",
    "orderId": "uuid",
    "amount": 99.0,
    "currency": "RUB",
    "date": 1704067200000,
    "status": "success",
    "planId": "plan_30",
    "planName": "1 месяц"
  }
]
```

## API v1 - Пользователь

### GET /v1/user/config

Получение VPN конфигурационного ключа.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ:**
```json
{
  "ok": true,
  "config": "vless://..."
}
```

**Ошибки:**
- `404 Not Found` - у пользователя нет активной подписки

Ключ кэшируется в базе данных для быстрого доступа.

### GET /v1/user/status

Статус подписки пользователя.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ:**
```json
{
  "ok": true,
  "status": "active",
  "expiresAt": 1704067200000,
  "usedTraffic": 1073741824,
  "dataLimit": 0
}
```

Статусы: `active`, `disabled`

### POST /v1/user/regenerate

Регенерация VPN ключа.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ:**
```json
{
  "ok": true,
  "config": "vless://..."
}
```

Старый ключ автоматически деактивируется.

### POST /v1/user/renew

Продление подписки (для администраторов).

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Тело запроса:**
```json
{
  "tgId": 12345678,
  "days": 30
}
```

**Ответ:**
```json
{
  "ok": true
}
```

### GET /v1/user/billing

Статистика использования трафика.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ:**
```json
{
  "usedBytes": 1073741824,
  "limitBytes": null,
  "averagePerDayBytes": 53687091,
  "planId": null,
  "planName": null,
  "period": {
    "start": null,
    "end": 1704067200000
  }
}
```

### GET /v1/user/referrals

Статистика реферальной программы.

**Аутентификация:** Требуется  
**Rate Limit:** Применяется

**Ответ:**
```json
{
  "totalCount": 10,
  "trialCount": 5,
  "premiumCount": 3,
  "referralCode": "REF12345678"
}
```

## API v1 - Тарифы

### GET /v1/tariffs

Получение списка доступных тарифов.

**Аутентификация:** Опциональна  
**Rate Limit:** Применяется

**Ответ:**
```json
[
  {
    "id": "plan_30",
    "name": "1 месяц",
    "days": 30,
    "price_rub": 99.0,
    "price_stars": 75
  }
]
```

**Особенности:**
- Для неавторизованных пользователей показываются все тарифы, включая пробный
- Для авторизованных пользователей пробный тариф (`plan_7`) скрывается, если у них уже были оплаченные заказы
- Проверка выполняется как в базе API, так и в базе бота (если доступна)

## Коды ошибок

- `400 Bad Request` - невалидные входные данные
- `401 Unauthorized` - требуется аутентификация
- `403 Forbidden` - доступ запрещен
- `404 Not Found` - ресурс не найден
- `500 Internal Server Error` - внутренняя ошибка сервера

## Формат ошибок

Все ошибки возвращаются в формате:
```json
{
  "error": "ErrorCode",
  "message": "Human readable message",
  "details": {}
}
```

## Тарифные планы

Доступные `planId`:
- `plan_7` - 7 дней (пробный, 10₽)
- `plan_30` - 30 дней (99₽)
- `plan_90` - 90 дней (260₽)
- `plan_180` - 180 дней (499₽)
- `plan_365` - 365 дней (899₽)
