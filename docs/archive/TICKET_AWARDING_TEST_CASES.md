# Тест-кейсы для проверки начисления билетов

## Сценарий 1: Заказ обрабатывается через processPayment() когда он уже COMPLETED

**Предусловия:**
- Заказ имеет статус `COMPLETED`
- `processPayment()` вызывается для этого заказа

**Ожидаемое поведение:**
- ❌ `processPayment()` вернет `return` на строке 61
- ❌ `activateOrder()` НЕ будет вызван
- ❌ Билеты НЕ будут начислены автоматически

**Текущее поведение:** ПРОБЛЕМА - билеты не начисляются

**Решение:** Вызывать `activateOrder()` даже для COMPLETED заказов

---

## Сценарий 2: Заказ обрабатывается через activateOrder() когда он уже COMPLETED

**Предусловия:**
- Заказ имеет статус `COMPLETED`
- `activateOrder()` вызывается напрямую для этого заказа

**Ожидаемое поведение:**
- ✅ `activateOrder()` проверит статус (строка 108)
- ✅ Если COMPLETED, проверит билеты (строка 125-137)
- ✅ Вызовет `ContestService.awardSelfPurchaseTicket()` если билеты еще не начислены

**Текущее поведение:** ✅ РАБОТАЕТ - билеты начисляются

---

## Сценарий 3: Новый заказ обрабатывается через processPayment()

**Предусловия:**
- Заказ имеет статус `CREATED` или `INVOICED`
- `processPayment()` вызывается для этого заказа

**Ожидаемое поведение:**
- ✅ `processPayment()` установит статус `PAID`
- ✅ Вызовет `activateOrder()`
- ✅ `activateOrder()` активирует подписку и начислит билеты

**Текущее поведение:** ✅ РАБОТАЕТ - билеты начисляются

---

## Сценарий 4: Заказ обрабатывается через API webhook

**Предусловия:**
- Заказ существует в API базе
- Webhook от YooKassa приходит с `payment.succeeded`

**Ожидаемое поведение:**
- ✅ `awardTicketsForPayment()` вызывается из `payments.ts`
- ✅ Билеты начисляются автоматически

**Текущее поведение:** ⚠️ Не тестировалось (все заказы обрабатываются ботом)

---

## Результаты тестирования:

### ✅ Работает:
- `activateOrder()` для COMPLETED заказов (если вызывается напрямую)
- `activateOrder()` для новых заказов
- `awardSelfPurchaseTicket()` корректно проверяет и начисляет билеты

### ❌ Не работает:
- `processPayment()` не вызывает `activateOrder()` для уже COMPLETED заказов
- Если заказ стал COMPLETED другим способом (не через `activateOrder()`), билеты не начисляются

### ❓ Требует проверки:
- Обработка заказов через API webhook
- Логирование вызовов функций начисления билетов
