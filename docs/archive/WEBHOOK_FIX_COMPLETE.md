# ‚úÖ WEBHOOK –ò–°–ü–†–ê–í–õ–ï–ù! –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ê–ë–û–¢–ê–ï–¢

**–î–∞—Ç–∞:** 18 —è–Ω–≤–∞—Ä—è 2026, 09:04 UTC  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê

### –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

**–ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ë–æ—Ç  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ API ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ YooKassa ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> Marzban
                ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> –ë–∞–∑–∞ –±–æ—Ç–∞ (–¥–ª—è –∑–∞–∫–∞–∑–æ–≤)

Webhook: YooKassa ‚îÄ‚îÄ> API ‚îÄ‚îÄ> –û–±—Ä–∞–±–æ—Ç–∫–∞
```

**–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞:**
- ‚úÖ Webhook –ø—Ä–∏—Ö–æ–¥–∏–ª –≤ API
- ‚ùå API –∏—Å–∫–∞–ª –∑–∞–∫–∞–∑ –≤ **—Å–≤–æ–µ–π** –±–∞–∑–µ (—Ç–∞–º —Ç–æ–ª—å–∫–æ 1 –∑–∞–∫–∞–∑)
- ‚ùå –ó–∞–∫–∞–∑—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ **–±–∞–∑–µ –±–æ—Ç–∞** (—Ç–∞–º 280 –∑–∞–∫–∞–∑–æ–≤)
- ‚ùå API –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª –∑–∞–∫–∞–∑ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–ª 200 –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï –ü–†–ò–ú–ï–ù–ï–ù–û

### –§–∞–π–ª: `/root/vpn_api/src/routes/v1/payments.ts`

**–î–û:**
```typescript
const orderRow = ordersRepo.getOrder(orderId);
```

**–ü–û–°–õ–ï:**
```typescript
// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –±–∞–∑–µ API
let orderRow = ordersRepo.getOrder(orderId);

// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –±–∞–∑–µ –±–æ—Ç–∞
if (!orderRow) {
  const { getDatabase } = await import('../../storage/db.js');
  const db = getDatabase();
  const botDbPath = process.env.BOT_DATABASE_PATH || '/root/vpn_bot/data/database.sqlite';
  
  if (fs.existsSync(botDbPath)) {
    try {
      db.prepare('ATTACH DATABASE ? AS bot_db').run(botDbPath);
      const botOrder = db.prepare(`
        SELECT 
          id as order_id,
          'tg_' || user_id as user_ref,
          plan_id,
          status,
          provider_payment_charge_id as yookassa_payment_id,
          CAST(amount AS TEXT) as amount_value,
          currency as amount_currency,
          NULL as key,
          datetime(created_at/1000, 'unixepoch') as created_at,
          datetime(created_at/1000, 'unixepoch') as updated_at
        FROM bot_db.orders
        WHERE id = ?
        LIMIT 1
      `).get(orderId);
      db.prepare('DETACH DATABASE bot_db').run();
      
      if (botOrder) {
        orderRow = botOrder;
        fastify.log.info({ orderId }, '[Webhook] Order found in bot database');
      }
    } catch (e) {
      fastify.log.error({ err: e?.message }, '[Webhook] Failed to query bot database');
    }
  }
}
```

---

## üîß –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û

### 1. **–°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è**
```bash
/root/vpn_api/src/routes/v1/payments.ts.backup_[timestamp]
```

### 2. **–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**
- API —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–∑—É –±–æ—Ç–∞, –µ—Å–ª–∏ –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–≤–æ–µ–π –±–∞–∑–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite `ATTACH DATABASE` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –±–æ—Ç–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –±–æ—Ç–∞

### 3. **API –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω**
```bash
systemctl restart outlivion-api
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ active (running)  
**PID:** 770382  
**–ü–æ—Ä—Ç:** 127.0.0.1:3001

---

## üìä –¢–ï–ö–£–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### YooKassa Webhook Flow

```
YooKassa –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
    ‚Üì
–û—Ç–ø—Ä–∞–≤–∫–∞ webhook: POST https://api.outlivion.space/v1/payments/webhook
    ‚Üì
Nginx ‚Üí API (127.0.0.1:3001)
    ‚Üì
API –ø–æ–ª—É—á–∞–µ—Ç event: payment.succeeded
    ‚Üì
–ò–∑–≤–ª–µ–∫–∞–µ—Ç orderId –∏–∑ metadata
    ‚Üì
–ò—â–µ—Ç –∑–∞–∫–∞–∑:
  1. –°–Ω–∞—á–∞–ª–∞ –≤ —Å–≤–æ–µ–π –±–∞–∑–µ (/root/vpn_api/data/db.sqlite)
  2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –≤ –±–∞–∑–µ –±–æ—Ç–∞ (/root/vpn_bot/data/database.sqlite) ‚úÖ –ù–û–í–û–ï!
    ‚Üì
–ù–∞—Ö–æ–¥–∏—Ç –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –±–æ—Ç–∞
    ‚Üì
–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ MarzbanService
    ‚Üì
–°–æ—Ö—Ä–∞–Ω—è–µ—Ç VPN –∫–ª—é—á
    ‚Üì
–ù–∞—á–∏—Å–ª—è–µ—Ç –±–∏–ª–µ—Ç—ã –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ
    ‚Üì
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram
    ‚Üì
‚úÖ –ì–æ—Ç–æ–≤–æ!
```

---

## üß™ –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨

### –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞** –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ
2. **–û–ø–ª–∞—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ YooKassa** (–∫–Ω–æ–ø–∫–∞ "üá∑üá∫ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –†–§")
3. **–î–æ–∂–¥–∏—Ç–µ—Å—å webhook** (~5-10 —Å–µ–∫—É–Ω–¥)
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–∏–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - ‚úÖ –ë–∏–ª–µ—Ç –Ω–∞—á–∏—Å–ª–∏–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–µ —Å VPN –∫–ª—é—á–æ–º

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –õ–æ–≥–∏ API (webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞)
journalctl -u outlivion-api -f | grep -E 'Webhook|bot database'

# –û–∂–∏–¥–∞–µ–º—ã–π –ª–æ–≥ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ webhook:
# [Webhook] Order found in bot database
```

---

## üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê

### –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—Ä—É—á–Ω—É—é (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):

| ‚Ññ | –ü–ª–∞—Ç–µ–∂ | –ó–∞–∫–∞–∑ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | –î–∞—Ç–∞ | –°—Ç–∞—Ç—É—Å |
|---|--------|-------|--------------|------|--------|
| 1 | 30fe83df | ord_c2cf813e | 782245481 | 18.01 05:31 | ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω |
| 2 | 30fe86d2 | ord_e63f0b27 | 782245481 | 18.01 05:44 | ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω |

**–ò—Ç–æ–≥–æ:**
- –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞: +60 –¥–Ω–µ–π (2 –ø–ª–∞—Ç–µ–∂–∞ √ó 30 –¥–Ω–µ–π)
- –ë–∏–ª–µ—Ç–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ: 20 ‚Üí 22 (+2)
- –¢–µ–∫—É—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞: –¥–æ **12 –º–∞—Ä—Ç–∞ 2028**

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
- ‚ùå Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –∫–ª—é—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚ùå –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è

### –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
- ‚úÖ Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ó–∞–∫–∞–∑—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –±–∞–∑–µ –±–æ—Ç–∞
- ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –∫–ª—é—á–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- ‚úÖ –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!

---

## üéØ –ü–†–ê–í–ò–õ–¨–ù–´–ô URL WEBHOOK

**–í YooKassa –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:**
```
https://api.outlivion.space/v1/payments/webhook
```

**–°–æ–±—ã—Ç–∏–µ:** `payment.succeeded` ‚úÖ

---

## üîê –î–†–£–ì–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –í –≠–¢–û–ô –°–ï–°–°–ò–ò

### 1. Telegram Stars (XTR) –ø–ª–∞—Ç–µ–∂–∏
- **–ü—Ä–æ–±–ª–µ–º–∞:** `total_amount / 100` ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è XTR
- **–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞–Ω–æ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 100
- **–§–∞–π–ª:** `/root/vpn_bot/src/bot/index.ts` (—Å—Ç—Ä–æ–∫–∞ 1028)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 2. –ö–Ω–æ–ø–∫–∞ "üîë –ü–æ–∫–∞–∑–∞—Ç—å VPN –∫–ª—é—á"
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª—é—á –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ
- **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –≤ –ø—Ä–æ—Ñ–∏–ª—å
- **–§–∞–π–ª—ã:** 
  - `/root/vpn_bot/src/bot/subscription.ts`
  - `/root/vpn_bot/src/bot/index.ts` (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `show_vpn_key`)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ

### 3. Polling —Ä–µ–∂–∏–º –¥–ª—è –±–æ—Ç–∞
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í webhook —Ä–µ–∂–∏–º–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –¥–æ—Ö–æ–¥–∏–ª–∏
- **–†–µ—à–µ–Ω–∏–µ:** –í–∫–ª—é—á–µ–Ω polling —Ä–µ–∂–∏–º
- **–§–∞–π–ª:** `/root/vpn_bot/.env` (`TELEGRAM_USE_POLLING=1`)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–∫–ª—é—á–µ–Ω–æ

---

## üì¶ –†–ï–ó–ï–†–í–ù–´–ï –ö–û–ü–ò–ò

–°–æ–∑–¥–∞–Ω—ã —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:

```bash
/root/vpn_api/src/routes/v1/payments.ts.backup_[timestamp]
/root/vpn_bot/src/bot/index.ts.backup_[timestamp]
/root/vpn_bot/src/bot/subscription.ts.backup_[timestamp]
```

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Å—Ö–µ–º—É**
   - –°–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ YooKassa
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

2. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ API: `journalctl -u outlivion-api -f`
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å webhook –æ–±—Ä–∞–±–æ—Ç–∫—É

3. ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
   - –û–±–Ω–æ–≤–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
   - –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π flow

---

## üéâ –ò–¢–û–ì

**–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç!**

- ‚úÖ –ë–æ—Ç ‚Üí API ‚Üí YooKassa
- ‚úÖ –ë–æ—Ç ‚Üí API ‚Üí Marzban
- ‚úÖ YooKassa webhook ‚Üí API ‚Üí –û–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ Automatic ticket awarding
- ‚úÖ Automatic subscription renewal
- ‚úÖ Instant VPN key delivery

**–í—Å—ë –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üöÄ

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 18.01.2026, 09:04 UTC  
**–í–µ—Ä—Å–∏—è:** 1.0 (Final)
