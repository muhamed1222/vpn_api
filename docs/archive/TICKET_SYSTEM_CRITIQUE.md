# üîç –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Å—Ç–µ–º—ã –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤

## –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 2025-01-27

---

## üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –¥–≤—É—Ö —É—Ä–æ–≤–Ω—è—Ö:
1. **–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞** (—Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ `ticket_ledger` –∏ `ref_events`) - –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
2. **Fallback —Å–∏—Å—Ç–µ–º–∞** (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞) - –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

---

## ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª –≤ –∫–æ–¥–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `plan_id` ‚Üí –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–∞ –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ **4+ –º–µ—Å—Ç–∞—Ö**:

```sql
-- –ö–æ–¥ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤–µ–∑–¥–µ:
CASE 
  WHEN o.plan_id = 'plan_30' THEN 1
  WHEN o.plan_id = 'plan_90' THEN 3
  WHEN o.plan_id = 'plan_180' THEN 6
  WHEN o.plan_id = 'plan_365' THEN 12
  WHEN o.plan_id LIKE 'plan_%' THEN CAST(SUBSTR(o.plan_id, 6) AS INTEGER) / 30
  ELSE 1
END
```

**–ì–¥–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è:**
- `getReferralSummary()` - —Å—Ç—Ä–æ–∫–∞ 261-270 (fallback –ª–æ–≥–∏–∫–∞)
- `getReferralFriends()` - —Å—Ç—Ä–æ–∫–∞ 443-449 (fallback –ª–æ–≥–∏–∫–∞)
- `getTicketHistory()` - —Å—Ç—Ä–æ–∫–∞ 557-562 (fallback –ª–æ–≥–∏–∫–∞)
- `getAllContestParticipants()` - —Å—Ç—Ä–æ–∫–∞ 773-776 (fallback –ª–æ–≥–∏–∫–∞)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ù–∞—Ä—É—à–µ–Ω–∏–µ DRY –ø—Ä–∏–Ω—Ü–∏–ø–∞
- ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—Å—è –Ω–æ–≤—ã–π –ø–ª–∞–Ω, –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å 4+ –º–µ—Å—Ç–∞)
- ‚ùå –†–∏—Å–∫ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `getTicketsFromPlanId(planId: string): number` –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–∑–¥–µ.

---

### 2. Fallback –ª–æ–≥–∏–∫–∞ –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í fallback –ª–æ–≥–∏–∫–µ (—Å—Ç—Ä–æ–∫–∞ 261-278 –≤ `getReferralSummary`) –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏:

```sql
-- –°—á–∏—Ç–∞—é—Ç—Å—è –í–°–ï –∑–∞–∫–∞–∑—ã, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≤—è–∑–∫–∏:
SELECT COALESCE(SUM(...), 0) as tickets_total
FROM bot_db.orders o
JOIN bot_db.user_referrals ur ON ur.referred_id = o.user_id
WHERE ur.referrer_id = ?
  AND o.status IN ('PAID', 'COMPLETED')
-- ‚ùå –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ (7 –¥–Ω–µ–π)!
-- ‚ùå –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≤—è–∑–∫–∏ (bound_at)!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ë–∏–ª–µ—Ç—ã –º–æ–≥—É—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –∑–∞ –ø–ª–∞—Ç–µ–∂–∏, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –î–û –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
- ‚ùå –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –ø–ª–∞—Ç–µ–∂–∏, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –ü–û–°–õ–ï –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ (7 –¥–Ω–µ–π)
- ‚ùå –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ fallback —Ä–µ–∂–∏–º–µ

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ –ø—Ä–∞–≤–∏–ª:**
> "–û–ø–ª–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ (bound_at)"

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ –≤ fallback –ª–æ–≥–∏–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≤—è–∑–∫–∏).

---

### 3. Fallback –ª–æ–≥–∏–∫–∞ –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–∏–æ–¥ –∫–æ–Ω–∫—É—Ä—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í fallback –ª–æ–≥–∏–∫–µ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –ø–ª–∞—Ç–µ–∂ –≤ –ø–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞:

```sql
-- –°—á–∏—Ç–∞—é—Ç—Å—è –í–°–ï –∑–∞–∫–∞–∑—ã –æ—Ç –¥—Ä—É–∑–µ–π, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –î–û –∫–æ–Ω–∫—É—Ä—Å–∞:
SELECT COALESCE(SUM(...), 0) as tickets_total
FROM bot_db.orders o
JOIN bot_db.user_referrals ur ON ur.referred_id = o.user_id
WHERE ur.referrer_id = ?
  AND o.status IN ('PAID', 'COMPLETED')
-- ‚ùå –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—ã –∫–æ–Ω–∫—É—Ä—Å–∞ (starts_at, ends_at)!
-- ‚ùå –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ contest_id!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ë–∏–ª–µ—Ç—ã –º–æ–≥—É—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –∑–∞ –ø–ª–∞—Ç–µ–∂–∏, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –î–û –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
- ‚ùå –ë–∏–ª–µ—Ç—ã –º–æ–≥—É—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –∑–∞ –ø–ª–∞—Ç–µ–∂–∏, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –ü–û–°–õ–ï –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞
- ‚ùå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –∏—Å–∫–∞–∂–µ–Ω–∞

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
> "–ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞ –ø–ª–∞—Ç–µ–∂–∏ –≤ –ø–µ—Ä–∏–æ–¥ –∫–æ–Ω–∫—É—Ä—Å–∞"

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–∏–æ–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –≤ fallback –ª–æ–≥–∏–∫—É:
```sql
AND o.created_at >= ? -- contest.starts_at
AND o.created_at <= ? -- contest.ends_at
```

---

### 4. Fallback –ª–æ–≥–∏–∫–∞ –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é –¥—Ä—É–∑–µ–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í fallback –ª–æ–≥–∏–∫–µ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –±—ã–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–º –î–û –ø—Ä–∏–≤—è–∑–∫–∏ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ:

```sql
-- –°—á–∏—Ç–∞—é—Ç—Å—è –í–°–ï –∑–∞–∫–∞–∑—ã –æ—Ç –¥—Ä—É–∑–µ–π, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ —Ä–∞–Ω—å—à–µ:
SELECT COALESCE(SUM(...), 0) as tickets_total
FROM bot_db.orders o
JOIN bot_db.user_referrals ur ON ur.referred_id = o.user_id
WHERE ur.referrer_id = ?
  AND o.status IN ('PAID', 'COMPLETED')
-- ‚ùå –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏, –±—ã–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–º –î–û bound_at!
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ –ø—Ä–∞–≤–∏–ª:**
> "–ù–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —É –¥—Ä—É–≥–∞ —É–∂–µ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω—ã–µ –æ–ø–ª–∞—Ç—ã –¥–æ –ø—Ä–∏–≤—è–∑–∫–∏"

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- ‚ùå –°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–º–∞–Ω—É—Ç–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ fallback –ª–æ–≥–∏–∫—É:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –±—ã–ª –ü–û–°–õ–ï –ø—Ä–∏–≤—è–∑–∫–∏
AND NOT EXISTS (
  SELECT 1 FROM bot_db.orders o2
  WHERE o2.user_id = ur.referred_id
    AND o2.status IN ('PAID', 'COMPLETED')
    AND o2.created_at < ur.created_at -- –≤—Ä–µ–º—è –ø—Ä–∏–≤—è–∑–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
)
```

---

### 5. –ù–µ—Ç —Å–≤—è–∑–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º –∫–æ–Ω–∫—É—Ä—Å–æ–º –≤ fallback

**–ü—Ä–æ–±–ª–µ–º–∞:**
Fallback –ª–æ–≥–∏–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `contest_id` - –æ–Ω–∞ —Å—á–∏—Ç–∞–µ—Ç –±–∏–ª–µ—Ç—ã –¥–ª—è –í–°–ï–• –¥—Ä—É–∑–µ–π, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω–∫—É—Ä—Å–æ–≤, –±–∏–ª–µ—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ–Ω–∫—É—Ä—Å—É –≤ fallback —Ä–µ–∂–∏–º–µ

---

### 6. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –Ω–æ–≤–æ–π –∏ fallback –ª–æ–≥–∏–∫–æ–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (—Å `ticket_ledger`) –∏ fallback –ª–æ–≥–∏–∫–∞ (—Å—Ç–∞—Ä–∞—è) –¥–∞—é—Ç **—Ä–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã**:

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ | Fallback –ª–æ–≥–∏–∫–∞ |
|----------|--------------|-----------------|
| –û–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ (7 –¥–Ω–µ–π) | ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è | ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è |
| –ü–µ—Ä–∏–æ–¥ –∫–æ–Ω–∫—É—Ä—Å–∞ | ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è | ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è |
| –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è (–±—ã–ª –ª–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–º) | ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è | ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è |
| –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω–∫—É—Ä—Å (`contest_id`) | ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è | ‚ùå –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è |

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —Ä–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ç–∞–±–ª–∏—Ü
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏

---

### 7. –†–∞—Å—á–µ—Ç rank/total_participants –≤—Å–µ –µ—â–µ –≤ –∫–æ–¥–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í `getReferralSummary()` (—Å—Ç—Ä–æ–∫–∏ 283-327) –≤—Å–µ –µ—â–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `rank` –∏ `total_participants`, —Ö–æ—Ç—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏—Ö **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç** (–±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ —Ç–∏–ø–æ–≤).

**–ö–æ–¥:**
```typescript
// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
let rank: number | null = null;
let totalParticipants: number | null = null;

// ... —Å–ª–æ–∂–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å CTE ...

return {
  // ...
  rank: rank,  // ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º!
  total_participants: totalParticipants,  // ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º!
};
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –õ–∏—à–Ω–∏–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- ‚ùå –î–æ—Ä–æ–≥–æ–π SQL –∑–∞–ø—Ä–æ—Å —Å CTE –∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞–º–∏ (—Å—Ç—Ä–æ–∫–∏ 302-316)
- ‚ùå –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ API
- ‚ùå –ó–∞–ø—É—Ç—ã–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—á–µ—Ç `rank` –∏ `total_participants` –∏–∑ –∫–æ–¥–∞, —Ç.–∫. —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç.

---

### 8. –ù–µ—Ç –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ plan_id

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `plan_id` ‚Üí –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö:
- SQL –∑–∞–ø—Ä–æ—Å—ã –≤ `contestRepo.ts` (4+ –º–µ—Å—Ç–∞)
- –í–æ–∑–º–æ–∂–Ω–æ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö –∫–æ–¥–∞ (–±–æ—Ç, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –†–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏
- ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—É—é —É—Ç–∏–ª–∏—Ç—É `planIdToTickets(planId: string): number` –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–∑–¥–µ.

---

### 9. –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ plan_id

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í SQL –∑–∞–ø—Ä–æ—Å–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ELSE 1`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- –ï—Å–ª–∏ `plan_id` –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω ‚Üí –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è 1 –±–∏–ª–µ—Ç

**–ö–æ–¥:**
```sql
CASE 
  WHEN o.plan_id = 'plan_30' THEN 1
  -- ...
  ELSE 1  -- ‚ùå –ß—Ç–æ –µ—Å–ª–∏ plan_id = NULL –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π?
END
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ `plan_id` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–≤—Å–µ–≥–¥–∞ 1 –±–∏–ª–µ—Ç)
- ‚ùå –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
- ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ELSE 0` –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö `plan_id`

---

### 10. –ù–µ—è—Å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞–Ω–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ï—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞–Ω–æ–≤:
```sql
WHEN o.plan_id LIKE 'plan_%' THEN CAST(SUBSTR(o.plan_id, 6) AS INTEGER) / 30
```

**–í–æ–ø—Ä–æ—Å—ã:**
- –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–ª–∞–Ω—ã? (–≤ `plans.ts` —Ç–æ–ª—å–∫–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 30? (30 –¥–Ω–µ–π = 1 –º–µ—Å—è—Ü)
- –ß—Ç–æ –µ—Å–ª–∏ `plan_id = 'plan_7'` (7 –¥–Ω–µ–π)? ‚Üí `7/30 = 0` (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤ SQL)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ù–µ—è—Å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
- ‚ùå –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è

---

## ‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 11. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –∫–∞–∂–¥–æ–º –º–µ—Ç–æ–¥–µ (`getReferralSummary`, `getReferralFriends`, `getTicketHistory`) –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü:

```typescript
const refEventsExists = db.prepare(`
  SELECT name FROM bot_db.sqlite_master 
  WHERE type='table' AND name='ref_events'
`).get();
```

**–†–µ—à–µ–Ω–∏–µ:**
–í—ã–Ω–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∞–±–ª–∏—Ü –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.

---

### 12. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –¥–ª—è ATTACH/DETACH

**–ü—Ä–æ–±–ª–µ–º–∞:**
`ATTACH DATABASE` –º–æ–∂–µ—Ç –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è, –Ω–æ –Ω–µ—Ç —è–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:

```typescript
db.prepare('ATTACH DATABASE ? AS bot_db').run(botDbPath);
// ‚ùå –ß—Ç–æ –µ—Å–ª–∏ botDbPath –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–ª–∏ –±–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞?
```

---

### 13. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è JOIN –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–ª–∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã –≤–º–µ—Å—Ç–æ JOIN:

```sql
-- –°—Ç—Ä–æ–∫–∞ 433-436: EXISTS –ø–æ–¥–∑–∞–ø—Ä–æ—Å
WHEN EXISTS (
  SELECT 1 FROM bot_db.orders o 
  WHERE o.user_id = ur.referred_id 
  AND o.status IN ('PAID', 'COMPLETED')
) THEN 'qualified'
```

**–†–µ—à–µ–Ω–∏–µ:**
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã, –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è.

---

## ‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ï—Å—Ç—å fallback –ª–æ–≥–∏–∫–∞** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
2. **–ï—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü** - –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
3. **–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ticket_ledger`** - —Ç–æ—á–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤
4. **–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
5. **–ï—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –±–∏–ª–µ—Ç–æ–≤** - –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –æ—Ç–∫—É–¥–∞ –≤–∑—è–ª–∏—Å—å –±–∏–ª–µ—Ç—ã

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∫—Ä–∏—Ç–∏—á–Ω–æ)

1. **–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ `plan_id` ‚Üí –±–∏–ª–µ—Ç—ã**
   - –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å fallback –ª–æ–≥–∏–∫—É**
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ (7 –¥–Ω–µ–π)
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–∏–æ–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥—Ä—É–∑–µ–π
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `contest_id`

3. **–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—á–µ—Ç `rank`/`total_participants`**
   - –£–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–π –∫–æ–¥
   - –£—Å–∫–æ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç API

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

4. **–í—ã–Ω–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∞–±–ª–∏—Ü –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é**
   - –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

5. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é `plan_id`**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ELSE 0` –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤

6. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã**
   - –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
   - –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ JOIN

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

7. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –¥–ª—è ATTACH/DETACH**
8. **–£—Ç–æ—á–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞–Ω–æ–≤**

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | 5/10 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞, –Ω–µ—Ç –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏ –∏—Å—Ç–∏–Ω—ã |
| **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å** | 4/10 | Fallback –ª–æ–≥–∏–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | 6/10 | –õ–∏—à–Ω–∏–µ —Ä–∞—Å—á–µ—Ç—ã (rank), –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã |
| **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** | 4/10 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** | 6/10 | –ï—Å—Ç—å fallback, –Ω–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: 5/10** ‚ö†Ô∏è

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

```typescript
/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç plan_id –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤ (–º–µ—Å—è—Ü–µ–≤)
 */
export function getTicketsFromPlanId(planId: string | null): number {
  if (!planId) return 0;
  
  // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–ª–∞–Ω—ã
  const fixedPlans: Record<string, number> = {
    'plan_30': 1,
    'plan_90': 3,
    'plan_180': 6,
    'plan_365': 12,
  };
  
  if (planId in fixedPlans) {
    return fixedPlans[planId];
  }
  
  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–ª–∞–Ω—ã (plan_XXX –≥–¥–µ XXX = –¥–Ω–∏)
  if (planId.startsWith('plan_')) {
    const days = parseInt(planId.substring(5), 10);
    if (!isNaN(days) && days > 0) {
      return Math.ceil(days / 30); // –û–∫—Ä—É–≥–ª—è–µ–º –≤–≤–µ—Ä—Ö –¥–æ –º–µ—Å—è—Ü–∞
    }
  }
  
  // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π plan_id
  console.warn(`[getTicketsFromPlanId] Unknown plan_id: ${planId}`);
  return 0;
}
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è fallback –ª–æ–≥–∏–∫–∞

```sql
-- –° –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏, –ø–µ—Ä–∏–æ–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏
SELECT COALESCE(SUM(getTicketsFromPlanId(o.plan_id)), 0) as tickets_total
FROM bot_db.orders o
JOIN bot_db.user_referrals ur ON ur.referred_id = o.user_id
WHERE ur.referrer_id = ?
  AND o.status IN ('PAID', 'COMPLETED')
  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–∏–æ–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
  AND o.created_at >= ? -- contest.starts_at
  AND o.created_at <= ? -- contest.ends_at
  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ (7 –¥–Ω–µ–π –æ—Ç bound_at)
  AND o.created_at <= datetime(ur.created_at, '+7 days')
  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–µ –±—ã–ª –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–º –¥–æ –ø—Ä–∏–≤—è–∑–∫–∏)
  AND NOT EXISTS (
    SELECT 1 FROM bot_db.orders o2
    WHERE o2.user_id = ur.referred_id
      AND o2.status IN ('PAID', 'COMPLETED')
      AND o2.created_at < ur.created_at
  )
```

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ –∏–º–µ–µ—Ç **—Å–µ—Ä—å–µ–∑–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**:

- ‚ùå **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** (–º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ –≤ 4+ –º–µ—Å—Ç–∞—Ö)
- ‚ùå **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è fallback –ª–æ–≥–∏–∫–∞** (–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏, –ø–µ—Ä–∏–æ–¥ –∫–æ–Ω–∫—É—Ä—Å–∞, –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é)
- ‚ùå **–õ–∏—à–Ω–∏–π –∫–æ–¥** (—Ä–∞—Å—á–µ—Ç rank –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- ‚ö†Ô∏è **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–æ–Ω–∫—É—Ä—Å–∞–º–∏.

---

*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ –≤ `src/storage/contestRepo.ts`*
