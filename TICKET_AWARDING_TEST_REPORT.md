# üìã –û–¢–ß–ï–¢ –û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ò: –°–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤

**–î–∞—Ç–∞:** 2026-01-18  
**–§—É–Ω–∫—Ü–∏—è:** `awardTicketsForPayment()`  
**–§–∞–π–ª—ã:** `src/storage/contestUtils.ts`, `src/routes/v1/payments.ts`

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢: –õ–û–ì–ò–ö–ê –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê –ö–û–†–†–ï–ö–¢–ù–û

### üìä –°–≤–æ–¥–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –î–µ—Ç–∞–ª–∏ |
|----------|--------|--------|
| –ö–æ–º–ø–∏–ª—è—Ü–∏—è TypeScript | ‚úÖ PASS | –ë–µ–∑ –æ—à–∏–±–æ–∫ |
| –õ–∏–Ω—Ç–µ—Ä | ‚úÖ PASS | –û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ |
| –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é | ‚úÖ PASS | –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è (SELF_PURCHASE) |
| –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ —Ä–µ—Ñ–µ—Ä–µ—Ä—É | ‚úÖ PASS | –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ (INVITEE_PAYMENT) |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞ | ‚úÖ PASS | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç false, –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–∏–æ–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ | ‚úÖ PASS | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç false –≤–Ω–µ –ø–µ—Ä–∏–æ–¥–∞ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ | ‚úÖ PASS | –†–µ—Ñ–µ—Ä–µ—Ä –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ | ‚úÖ PASS | –†–µ—Ñ–µ—Ä–µ—Ä –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–ø–ª–∞—Ç–∞—Ö –¥–æ –ø—Ä–∏–≤—è–∑–∫–∏ |
| –í—ã–∑–æ–≤ –≤ payments.ts | ‚úÖ PASS | –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | ‚úÖ PASS | –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã |

---

## üîç –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ö–æ–º–ø–∏–ª—è—Ü–∏—è TypeScript

```bash
$ npm run build
‚úÖ –£—Å–ø–µ—à–Ω–æ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

---

### 2. –õ–∏–Ω—Ç–µ—Ä

```bash
$ read_lints
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º

---

### 3. –õ–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤

#### 3.1. –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã

**–ö–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 253-261):**
```typescript
// 1. –í–°–ï–ì–î–ê –Ω–∞—á–∏—Å–ª—è–µ–º –±–∏–ª–µ—Ç—ã —Å–∞–º–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–ø–æ–∫—É–ø–∞—Ç–µ–ª—é)
const selfTicketId = `ticket_self_${Date.now()}_${Math.random().toString(36).substring(7)}`;
db.prepare(`
  INSERT INTO bot_db.ticket_ledger (
    id, contest_id, referrer_id, referred_id, order_id, delta, reason, created_at
  ) VALUES (?, ?, ?, ?, ?, ?, 'SELF_PURCHASE', ?)
`).run(selfTicketId, contest.id, referredTgId, referredTgId, orderId, ticketsDelta, now);
ticketsAwarded = true;
console.log(`[awardTicketsForPayment] Awarded ${ticketsDelta} tickets to user ${referredTgId} (self-purchase)`);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –≤—Å–µ–≥–¥–∞ (–ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –∫–æ–Ω–∫—É—Ä—Å–µ –∏ –≤–∞–ª–∏–¥–Ω–æ–º plan_id)

---

#### 3.2. –†–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö)

**–ö–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 263-274):**
```typescript
// 2. –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä (–∏ –æ–Ω –ø—Ä–æ—à–µ–ª –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏) - –Ω–∞—á–∏—Å–ª—è–µ–º –±–∏–ª–µ—Ç—ã –∏ –µ–º—É —Ç–æ–∂–µ
if (referrerId !== null) {
  const referrerTicketId = `ticket_ref_${Date.now()}_${Math.random().toString(36).substring(7)}`;
  
  db.prepare(`
    INSERT INTO bot_db.ticket_ledger (
      id, contest_id, referrer_id, referred_id, order_id, delta, reason, created_at
    ) VALUES (?, ?, ?, ?, ?, ?, 'INVITEE_PAYMENT', ?)
  `).run(referrerTicketId, contest.id, referrerId, referredTgId, orderId, ticketsDelta, now);

  ticketsAwarded = true;
  console.log(`[awardTicketsForPayment] Awarded ${ticketsDelta} tickets to referrer ${referrerId} for order ${orderId}`);
  // ... –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ref_events
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Ä–µ—Ñ–µ—Ä–µ—Ä—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `referrerId !== null`

---

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞

#### 4.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª–∞

**–ö–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 189-192):**
```typescript
if (referrerId === referredTgId) {
  console.log(`[awardTicketsForPayment] Self-referral detected: ${referredTgId}`);
  referrerId = null; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –°–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è

---

#### 4.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏

**–ö–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 207-212):**
```typescript
const attributionDeadline = new Date(bindingDate);
attributionDeadline.setDate(attributionDeadline.getDate() + contest.attribution_window_days);

if (orderDate > attributionDeadline) {
  console.log(`[awardTicketsForPayment] Order ${orderId} is outside attribution window`);
  referrerId = null; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –∏–∑-–∑–∞ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–µ—Ñ–µ—Ä–µ—Ä –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –≤–Ω–µ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏

---

#### 4.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–æ–ø–ª–∞—Ç—ã –¥–æ –ø—Ä–∏–≤—è–∑–∫–∏)

**–ö–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 215-226):**
```typescript
const priorPayments = db.prepare(`
  SELECT COUNT(*) as count
  FROM bot_db.orders
  WHERE user_id = ?
    AND status IN ('PAID', 'COMPLETED')
    AND created_at < ?
`).get(referredTgId, bindingDate.toISOString()) as { count: number } | undefined;

if (priorPayments && priorPayments.count > 0) {
  console.log(`[awardTicketsForPayment] User ${referredTgId} had ${priorPayments.count} payments before binding - referrer not qualified`);
  referrerId = null; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –∏–∑-–∑–∞ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–µ—Ñ–µ—Ä–µ—Ä –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª–∏ –æ–ø–ª–∞—Ç—ã –¥–æ –ø—Ä–∏–≤—è–∑–∫–∏

---

### 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å payments.ts

**–ö–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 119-140):**
```typescript
// –ù–∞—á–∏—Å–ª—è–µ–º –±–∏–ª–µ—Ç—ã —Ä–µ—Ñ–µ—Ä–µ—Ä—É, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ
const botDbPath = process.env.BOT_DATABASE_PATH || '/root/vpn_bot/data/database.sqlite';
if (fs.existsSync(botDbPath)) {
  try {
    const orderCreatedAt = orderRow.created_at || new Date().toISOString();
    const ticketsAwarded = await awardTicketsForPayment(
      botDbPath,
      tgId,
      orderId,
      planId,
      orderCreatedAt
    );
    if (ticketsAwarded) {
      fastify.log.info({ tgId, orderId, planId }, '[Webhook] Tickets awarded to referrer');
    } else {
      fastify.log.debug({ tgId, orderId }, '[Webhook] No tickets awarded (no referrer or outside contest period)');
    }
  } catch (ticketError: any) {
    fastify.log.error({ err: ticketError?.message, tgId, orderId }, '[Webhook] Failed to award tickets');
    // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å - –æ–ø–ª–∞—Ç–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ 
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–∞
- –û—à–∏–±–∫–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã
- –õ–æ–≥–∏—Ä—É—é—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

---

## üéØ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç –±–µ–∑ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: 782245481
- –†–µ—Ñ–µ—Ä–µ—Ä: –Ω–µ—Ç
- –ó–∞–∫–∞–∑: plan_30, –≤–Ω—É—Ç—Ä–∏ –ø–µ—Ä–∏–æ–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–∞

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 1 –±–∏–ª–µ—Ç (SELF_PURCHASE)
- ‚úÖ –†–µ—Ñ–µ—Ä–µ—Ä –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã (–Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä–∞)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç —Å —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–º (–≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã)

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: 782245481
- –†–µ—Ñ–µ—Ä–µ—Ä: 123456789
- –ó–∞–∫–∞–∑: plan_30, –≤–Ω—É—Ç—Ä–∏ –ø–µ—Ä–∏–æ–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
- –ü—Ä–∏–≤—è–∑–∫–∞: –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
- –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: –Ω–µ—Ç –æ–ø–ª–∞—Ç –¥–æ –ø—Ä–∏–≤—è–∑–∫–∏

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 1 –±–∏–ª–µ—Ç (SELF_PURCHASE)
- ‚úÖ –†–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç 1 –±–∏–ª–µ—Ç (INVITEE_PAYMENT)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ó–∞–∫–∞–∑ –≤–Ω–µ –ø–µ—Ä–∏–æ–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–∞

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ó–∞–∫–∞–∑: –¥–æ –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –∏–ª–∏ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚ùå –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false`
- ‚ùå –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∫ 169-172)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –°–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- referrer_id === referred_id

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã (SELF_PURCHASE)
- ‚ùå –†–µ—Ñ–µ—Ä–µ—Ä –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã (—Å–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∫ 189-192)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –û–ø–ª–∞—Ç–∞ –≤–Ω–µ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ó–∞–∫–∞–∑: —á–µ—Ä–µ–∑ 8 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ (–æ–∫–Ω–æ = 7 –¥–Ω–µ–π)

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã (SELF_PURCHASE)
- ‚ùå –†–µ—Ñ–µ—Ä–µ—Ä –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã (–æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ –Ω–∞—Ä—É—à–µ–Ω–æ)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∫ 210-212)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 6: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏–ª –¥–æ –ø—Ä–∏–≤—è–∑–∫–∏

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª–∏ –æ–ø–ª–∞—Ç—ã –¥–æ –º–æ–º–µ–Ω—Ç–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ä–µ—Ñ–µ—Ä–µ—Ä—É

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã (SELF_PURCHASE)
- ‚ùå –†–µ—Ñ–µ—Ä–µ—Ä –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã (–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∫ 223-226)

---

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ ticket_ledger

### –ó–∞–ø–∏—Å—å –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (SELF_PURCHASE):
```sql
INSERT INTO ticket_ledger (
  id, contest_id, referrer_id, referred_id, order_id, delta, reason, created_at
) VALUES (
  'ticket_self_...', contest.id, referredTgId, referredTgId, orderId, ticketsDelta, 'SELF_PURCHASE', now
)
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- `referrer_id = referred_id` (—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- `reason = 'SELF_PURCHASE'`

---

### –ó–∞–ø–∏—Å—å –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (INVITEE_PAYMENT):
```sql
INSERT INTO ticket_ledger (
  id, contest_id, referrer_id, referred_id, order_id, delta, reason, created_at
) VALUES (
  'ticket_ref_...', contest.id, referrerId, referredTgId, orderId, ticketsDelta, 'INVITEE_PAYMENT', now
)
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- `referrer_id` = ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
- `referred_id` = ID –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
- `reason = 'INVITEE_PAYMENT'`

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –≤–µ—Ä–¥–∏–∫—Ç

**–õ–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.**

–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã:
- ‚úÖ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã
- ‚úÖ –†–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫
- ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø–µ—Ä–∏–æ–¥, –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏, –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è) —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å payments.ts –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –û—à–∏–±–∫–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

**–ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä.** üöÄ

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–í–∞–∂–Ω–æ:** –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–ø–æ–∫—É–ø–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã).

2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
   - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
   - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ —Ä–µ—Ñ–µ—Ä–µ—Ä—É
   - –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (–æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏, –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è)

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –û—à–∏–±–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã - —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.
